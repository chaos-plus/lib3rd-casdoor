(self.webpackChunkweb=self.webpackChunkweb||[]).push([[8,1041],{98558:function(e,n,r){"use strict";r.r(n);var t=r(37762),i=r(74165),o=r(15861),a=r(29439),c=r(71543),s=r(47313),l=r(86445),u=r(43932),d=r(43295),f=r(31196),h=r(13608),v=r(14576),p=r(96351),g=r(59303),x=r(46417);n.default=function(e){var n=e.visible,r=e.onOk,Z=e.onCancel,m=e.withImage,w=s.useState(!1),k=(0,a.Z)(w,2),y=k[0],b=k[1],j=(0,s.useState)(!1),P=(0,a.Z)(j,2),C=P[0],F=P[1],E=s.useRef(),R=s.useRef(),D=s.useRef(null),I=s.useRef(null),O=(0,s.useState)(0),S=(0,a.Z)(O,2),L=S[0],N=S[1],T=(0,s.useState)([]),U=(0,a.Z)(T,2),M=U[0],A=U[1],B=s.useState(),q=(0,a.Z)(B,2),K=q[0],Q=q[1],z=s.useState(),G=(0,a.Z)(z,2),H=G[0],W=G[1];s.useEffect((function(){var e=function(){var e=(0,o.Z)((0,i.Z)().mark((function e(){var n;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n="https://cdn.casdoor.com/casdoor/models",Promise.all([c.qB.tinyFaceDetector.loadFromUri(n),c.qB.faceLandmark68Net.loadFromUri(n),c.qB.faceRecognitionNet.loadFromUri(n)]).then((function(e){b(!0)})).catch((function(e){l.ZP.error(p.Z.t("login:Model loading failure")),Z()}));case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();e()}),[]),s.useEffect((function(){if(!m)return n?(N(0),y&&navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}).then((function(e){I.current=e,F(!0)})).catch((function(e){X(e)}))):(clearInterval(D.current),D.current=null,F(!1)),function(){clearInterval(D.current),D.current=null,F(!1)}}),[n,y]),s.useEffect((function(){var e;if(!m)if(C)var n=0,r=setInterval((function(){n++,E.current&&(E.current.srcObject=I.current,E.current.play(),clearInterval(r)),n>=30&&(clearInterval(r),Z())}),100);else null===(e=I.current)||void 0===e||e.getTracks().forEach((function(e){return e.stop()})),E.current&&(E.current.srcObject=null)}),[C]);var J,V,X=function(e){Z(),e instanceof DOMException&&("NotFoundError"===e.name||"DevicesNotFoundError"===e.name?l.ZP.error(p.Z.t("login:Please ensure that you have a camera device for facial recognition")):"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?l.ZP.error(p.Z.t("login:Please provide permission to access the camera")):"NotReadableError"===e.name||"TrackStartError"===e.name?l.ZP.error(p.Z.t("login:The camera is currently in use by another webpage")):"TypeError"===e.name?l.ZP.error(p.Z.t("login:Please load the webpage using HTTPS, otherwise the camera cannot be accessed")):l.ZP.error(e.message))};return m?(0,x.jsx)("div",{children:(0,x.jsxs)(u.Z,{closable:!1,maskClosable:!1,destroyOnClose:!0,open:n,title:p.Z.t("login:Face Recognition"),width:350,footer:[(0,x.jsx)(d.ZP,{type:"primary",disabled:!K||0===(null===K||void 0===K?void 0:K.length),onClick:function(){r(Array.from(K.descriptor))},children:"Ok"},"ok"),(0,x.jsx)(d.ZP,{onClick:Z,children:"Cancel"},"back")],children:[(0,x.jsxs)(v.Z,{direction:"vertical",style:{width:"100%"},children:[(0,x.jsx)(g.Z,{multiple:!0,defaultFileList:M,style:{width:"100%"},beforeUpload:function(e){return function(e){return new Promise((function(n,r){var t=new FileReader;t.readAsDataURL(e),t.onload=function(){return n(t.result)},t.onerror=function(e){return r(e)}}))}(e).then((function(n){e.base64=n,M.push(e)})),Q([]),!1},onRemove:function(e){var n=M.indexOf(e),r=M.slice();r.splice(n,1),A(r),Q([])},children:(0,x.jsx)("p",{children:p.Z.t("general:Click to Upload")})}),y?(0,x.jsxs)(d.ZP,{style:{width:"100%"},onClick:(0,o.Z)((0,i.Z)().mark((function e(){var n,r,o,a,s,u,d,f,h,v;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=0,r=(0,t.Z)(M),e.prev=2,r.s();case 4:if((o=r.n()).done){e.next=15;break}return u=o.value,d=M.indexOf(u),(f=new Image).src=u.base64,e.next=11,c.Qr(f,new c.aK).withFaceLandmarks().withFaceDescriptors();case 11:h=e.sent,(null===(a=h[0])||void 0===a?void 0:a.detection.score)>.9&&(null===(s=h[0])||void 0===s?void 0:s.detection.score)>n&&(n=null===(v=h[0])||void 0===v?void 0:v.detection.score,Q(h[0]),W(d));case 13:e.next=4;break;case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(2),r.e(e.t0);case 20:return e.prev=20,r.f(),e.finish(20);case 23:n<.9&&l.ZP.error(p.Z.t("login:Face recognition failed"));case 24:case"end":return e.stop()}}),e,null,[[2,17,20,23]])}))),children:[" ",p.Z.t("application:Generate faceId")]}):null]}),K&&0!==K.length?(0,x.jsxs)(s.Fragment,{children:[(0,x.jsxs)("div",{children:[p.Z.t("application:Select"),":",null===(J=M[H])||void 0===J?void 0:J.name]}),(0,x.jsx)("div",{children:(0,x.jsx)("img",{src:null===(V=M[H])||void 0===V?void 0:V.base64,alt:"selected",style:{width:"100%"}})})]}):null]})}):(0,x.jsx)("div",{children:(0,x.jsxs)(u.Z,{closable:!1,maskClosable:!1,destroyOnClose:!0,open:n&&C,title:p.Z.t("login:Face Recognition"),width:350,footer:[(0,x.jsx)(d.ZP,{onClick:Z,children:"Cancel"},"back")],children:[(0,x.jsx)(f.Z,{percent:L}),(0,x.jsx)("div",{style:{marginTop:"20px",marginBottom:"50px",justifyContent:"center",alignContent:"center",position:"relative",flexDirection:"column"},children:y?(0,x.jsxs)("div",{style:{display:"flex",justifyContent:"center",alignContent:"center"},children:[(0,x.jsx)("video",{ref:E,onPlay:function(){if(!m){var e=0,t=0;D.current||(D.current=setInterval((0,o.Z)((0,i.Z)().mark((function o(){var a,s,u;return(0,i.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(!(y&&E.current&&n)){i.next=7;break}return i.next=3,c.Qr(E.current,new c.aK).withFaceLandmarks().withFaceDescriptors();case 3:a=i.sent,++e%50===0?l.ZP.warning(p.Z.t("login:Please ensure sufficient lighting and align your face in the center of the recognition box")):e>300&&(l.ZP.error(p.Z.t("login:Face recognition failed")),Z()),1===a.length?(s=a[0],N(Math.round(100*s.detection.score)),u=Array.from(s.descriptor),s.detection.score>.9&&(t++,(s.detection.score>.99||t>10)&&(clearInterval(D.current),r(u)))):N(Math.round(L/2));case 7:case"end":return i.stop()}}),o)}))),100))}},style:{borderRadius:"50%",height:"220px",verticalAlign:"middle",width:"220px",objectFit:"cover"}}),(0,x.jsx)("div",{style:{position:"absolute",width:"240px",height:"240px",top:"50%",left:"50%",transform:"translate(-50%, -50%)"},children:(0,x.jsx)("svg",{width:"240",height:"240",fill:"none",children:(0,x.jsx)("circle",{strokeDasharray:"700",strokeDashoffset:700-6.9115*L,strokeWidth:"4",cx:"120",cy:"120",r:"110",stroke:"#5734d3",transform:"rotate(-90, 120, 120)",strokeLinecap:"round",style:{transition:"all .2s linear"}})})}),(0,x.jsx)("canvas",{ref:R,style:{position:"absolute"}})]}):(0,x.jsx)("div",{children:(0,x.jsx)(h.Z,{tip:p.Z.t("login:Loading"),size:"large",style:{display:"flex",justifyContent:"center",alignContent:"center"},children:(0,x.jsx)("div",{className:"content"})})})})]})})}},64902:function(){},40522:function(){},90753:function(){},68730:function(){}}]);